<!DOCTYPE html>
<html>
    <head>
        <title>Statistics</title>
        <link rel="stylesheet" type="text/css" href="/newstyle.css" />
        <link rel="icon" type="image/x-icon" href="../images/favicon.ico" />
        <meta content="ze peppersite" property="og:title" />
        <meta content="ye" property="og:description" />
        <meta content="https://pepperbot.online" property="og:url" />
        <meta content="#ff0000" data-react-helmet="true" name="theme-color" />
    </head>
    <body>
        <div class="sidebar">
            <script id="definesidebarfunctions">
                let sidebarIsOpen = sessionStorage.getItem('sidebarIsOpen');;
                function redirectTo(url) {
                    sessionStorage.setItem('sidebarIsOpen', sidebarIsOpen);
                    window.location.href = url;
                }
                function openInNewTab(url) {
                    sessionStorage.setItem('sidebarIsOpen', sidebarIsOpen);
                    let win = window.open(
                        url,
                        "_blank"
                    );
                }
                function showSidebarToggler() {
                    const sidebarToggler = document.querySelector(".sidebarToggler");
                    sidebarToggler.style.opacity = "0.25";
                }
                function hideSidebarToggler() {
                    const sidebarToggler = document.querySelector(".sidebarToggler");
                    sidebarToggler.style.opacity = "0";
                }
            </script>
            <div class="sidebarToggler" onclick="toggleSidebar(); hideSidebarToggler()" onmouseover="showSidebarToggler()" onmouseout="hideSidebarToggler()"></div>
            <h2 class="sidebarTitle">NAVIGATION</h2>
            <div class="sidebarDivider"></div>
            <div class="sidebarButton" id="/" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Home</div>
            <div class="sidebarButton" id="/statistics" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Statistics</div>
            <div class="sidebarButton" id="/logs" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Logs</div>
            <div class="sidebarButton" id="/chat" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Chat</div>
            <div class="sidebarButton" id="/credits" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Credits</div>
            <div class="sidebarButton" id="/contact" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Contact</div>
            <div class="sidebarButton" id="/shame" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Shame</div>
            <div class="sidebarButton" id="/coolsites" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Cool Sites</div>
            <div class="sidebarButton" id="/simulations" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Simulations</div>
            <div class="sidebarButton" id="/todo" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Todo</div>
            <div class="sidebarButton" id="/updates" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)">Updates</div>

            <div class="sidebarButton" id="https://github.com/ayeuhugyu/pepperbot" onclick="redirectTo(this.id)" onauxclick="openInNewTab(this.id)" style="position: fixed; bottom: 0;">Source Code</div>
            <script id="sidebarmain">
                function toggleSidebar() {
                    document.querySelectorAll(".sidebar").forEach((element) => {
                        void element.offsetWidth;

                        if (sidebarIsOpen) {
                            element.style.animation = "slideOpen 0.5s forwards";
                        } else {
                            element.style.animation =
                                "slideClose 0.5s forwards";
                        }
                    });
                    sidebarIsOpen = !sidebarIsOpen;
                    sessionStorage.setItem('sidebarIsOpen', sidebarIsOpen);
                }
                document.addEventListener("keydown", (event) => {
                    if (event.key === "k" && event.target.tagName !== "INPUT" && event.target.tagName !== "TEXTAREA") {
                        toggleSidebar();
                    }
                });
                document
                    .querySelectorAll(".sidebarButton")
                    .forEach((button) => {
                        button.style.transition = "transform 0.25s ease-in-out";
                        button.addEventListener("mouseover", () => {
                            button.style.backgroundColor = "#13131d";
                            button.style.transform = "translateX(-100px)";
                        });
                        button.addEventListener("mouseout", () => {
                            button.style.backgroundColor = "#1E1E2E";
                            button.style.transform = "translateX(0px)";
                        });
                        button.addEventListener("mousedown", () => {
                            button.style.backgroundColor = "#616187";
                        });
                        button.addEventListener("mouseup", () => {
                            button.style.backgroundColor = "#616187";
                        });
                    });
                document.addEventListener("DOMContentLoaded", function () {
                    sidebarIsOpen = sessionStorage.getItem('sidebarIsOpen') === "true";
                    if (sidebarIsOpen) {
                        document
                            .querySelectorAll(".sidebar")
                            .forEach((element) => {
                                element.style.animation =
                                    "slideClose 0s forwards";
                            });
                    }
                });
            </script>
        </div>
        <pre id="fileContents" style="position: absolute"></pre>
        <div class="cardcontainer" id="maintitle" style="margin-left: 50%; margin-top: 15px; width: fit-content; transform: translateX(-50%); position: relative;">
            <div class="sectionoutline" style="justify-content: center; align-items: center; text-align: center;">
                <h2 class="sectionTitle">Statistics</h2>
            </div>
        </div>
        <div class="flexcontainer" style="margin-top: 15px;">
            <div class="container" id="chart" style="position: relative; padding-bottom: 15px">
                <div class="sectionoutline">
                    <div class="flexcontainer" id="chartsCardContainer" style="padding: 5px; flex-direction: column; width: calc(100vw - 50px); height: 410px;">
                        <h2 class="sectionTitle">CHARTS</h2>
                        <div id="information" class="flexcontainer" style="justify-content: space-between; width: 100%;">
                            <div id="selections" class="flexcontainer">
                                <span id="label">category: </span>
                                <div class="dropdown-wrapper" id="category">
                                    <select class="logLevelDropdown" id="categoryType">
                                        <option value="USAGE">USAGE</option>
                                        <option value="EXECUTION_TIME">EXECUTION TIME</option>
                                        <option value="HOURLY_USAGE">HOURLY USAGE</option>
                                    </select>
                                </div>
                                <span id="label"> display type: </span>
                                <div class="dropdown-wrapper" id="display">
                                    <select class="logLevelDropdown" id="displayType">
                                        <option value="HORIZONTAL">HORIZONTAL</option>
                                        <option value="VERTICAL">VERTICAL</option>
                                    </select>
                                </div>
                                <span id="label"> value type: </span>
                                <div class="dropdown-wrapper" id="value">
                                    <select class="logLevelDropdown" id="valueType">
                                        <option value="PERCENTAGE">PERCENTAGE</option>
                                        <option value="INTEGER">INTEGER</option>
                                    </select>
                                </div>
                            </div>
                            <div id="status" style="text-align: right;">awaiting input...</div>
                        </div>
                        <pre class="outlined" id="chartcontent" style="width: 100%; overflow: scroll; text-align: left; flex-grow: 1;"></pre>
                    </div>
                </div>
            </div>
            <div class="container" id="info" style="position: relative; padding-bottom: 15px;"></div>
                <div class="sectionoutline" style="width: calc(100vw - 40px);">
                    <div class="flexcontainer" style="padding: 5px; flex-direction: column; width: calc(100vw - 50px);">
                        <h2 class="sectionTitle">INFO</h2>
                        <pre class="outlined" id="statsContainer" style="width: 100%; height: 300px; overflow: scroll; text-align: left;"></pre>
                    </div>
                </div>
            </div>
        </div>
        <script>
            function hourToHumanReadable(hour) {
                hour = parseInt(hour) + 1;
                if (hour < 12) {
                    return `${hour} AM`;
                } else if (hour === 12) {
                    return `${hour} PM`;
                } else {
                    return `${hour - 12} PM`;
                }
            }

            fetch("/api/read-statistics")
                .then((response) => response.json())
                .then((jsonData) => {
                    const chartsCardContainer = document.getElementById("chartsCardContainer");
                    const chartContent = document.getElementById("chartcontent");
                    //chartContent.innerText = JSON.stringify(jsonData, null, 2);

                    const statistics = jsonData.statistics;
                    const totalUsage = Object.values(statistics.commandUsage).reduce((total, value) => total + value, 0);
                    let averageExecutionTimes = {};
                    for (const [command, executionTimes] of Object.entries(statistics.executionTime)) {
                        const averageExecutionTime = executionTimes.reduce((total, value) => total + value, 0) / executionTimes.length;
                        averageExecutionTimes[command] = averageExecutionTime;
                    }
                    const hourlyUsage = statistics.hourlyUsage;
                    const commandUsage = statistics.commandUsage;

                    let category = document.getElementById("categoryType").value;
                    let displayType = document.getElementById("displayType").value;
                    let valueType = document.getElementById("valueType").value;

                    const status = document.getElementById("status");

                    function createChart(data, valueType, vertical, category) {
                        // sort the data highest to lowest
                        status.innerText = "sorting data...."
                        if (category == "HOURLY_USAGE") { 
                            for (let i = 0; i < 24; i++) {
                                if (!data[i]) {
                                    data[i] = 0;
                                }
                            }
                        }
                        
                        const total = Object.values(data).reduce((total, value) => total + value, 0);
                        console.log(total, data)
                        let sortedData
                        let highestValue = 0;
                        if (category == "HOURLY_USAGE") {
                            sortedData = Object.entries(data).sort((a, b) => parseInt(a)[0] - parseInt(b)[0]);
                            highestValue = sortedData.reduce((max, value) => Math.max(max, value[1]), 0);
                        } else {
                            sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
                            highestValue = sortedData[0][1];
                        }
                        console.log(sortedData)
                        status.innerText = "generating chart...."
                        const bars = document.createElement("div");
                        bars.style.display = "flex";
                        bars.style.flexDirection = "row";
                        bars.style.width = "100%";
                        bars.style.height = "100%";
                        bars.style.alignItems = "flex-end";
                        for (const [key, value] of sortedData) {
                            const barHolder = document.createElement("div");
                            barHolder.style.width = "20px";
                            barHolder.style.height = "100%";
                            barHolder.style.outline = "1px solid #cca1db";
                            barHolder.style.position = "relative";
                            barHolder.style.marginRight = "5px";
                            if (vertical) {
                                barHolder.style.width = "100%"
                                barHolder.style.height = "20px"
                                barHolder.style.marginRight = "0px";
                                barHolder.style.marginBottom = "5px";
                            }
                            bars.appendChild(barHolder);

                            const bar = document.createElement("div");
                            bar.style.height = `${(value / highestValue) * 100}%`;
                            bar.style.width = "20px";
                            bar.style.backgroundColor = "#6a499c";
                            bar.style.color = "white";
                            bar.style.position = "absolute"; // Add this line
                            bar.style.bottom = "0"; // Add this line to align the bar to the bottom
                            if (vertical) {
                                bar.style.width = `${(value / highestValue) * 100}%`
                                bar.style.height = "100%"
                            }

                            const labelHolder = document.createElement("div");
                            labelHolder.style.display = "flex";
                            labelHolder.style.flexDirection = "column";
                            labelHolder.style.justifyContent = "space-around";
                            labelHolder.style.alignItems = "center";
                            labelHolder.style.width = "20px";
                            labelHolder.style.height = "calc(100% - 15px)";
                            labelHolder.style.position = "absolute"; // Add this line
                            labelHolder.style.top = "0"; // Add this line to align the labelHolder to the top
                            labelHolder.style.paddingBottom = "15px"
                            if (vertical) {
                                labelHolder.style.width = "100%"
                                labelHolder.style.height = "100%"
                                labelHolder.style.flexDirection = "row";
                                labelHolder.style.paddingBottom = "0px"
                            }
                            
                            barHolder.appendChild(bar);
                            barHolder.appendChild(labelHolder);
                            const nameObject = document.createElement("div");
                            nameObject.style.width = "fit-content";
                            nameObject.style.height = "20px";
                            nameObject.style.textAlign = "right";
                            nameObject.style.color = "lightgray";
                            nameObject.textContent = `${(category == "USAGE" || category == "EXECUTION_TIME") ? "p/" : ""}${key}`;
                            if (category == "HOURLY_USAGE") {
                                nameObject.textContent = hourToHumanReadable(key);
                            }
                            nameObject.style.transform = "rotate(-90deg)";
                            const valueObject = document.createElement("div");
                            valueObject.style.width = "fit-content";
                            valueObject.style.height = "20px";
                            valueObject.style.textAlign = "left";
                            valueObject.style.color = "lightgray";
                            valueObject.textContent = `${valueType === "PERCENTAGE" ? `${((value/total)*100).toFixed(2)}%`: `${category === "EXECUTION_TIME" ? value.toFixed(3) : value}`}${(category == "EXECUTION_TIME" && valueType !== "PERCENTAGE") ? "ms" : ""}`;
                            valueObject.style.transform = "rotate(-90deg)";
                            if (vertical) {
                                nameObject.style.transform = "rotate(0deg)";
                                valueObject.style.transform = "rotate(0deg)";
                            }
                            labelHolder.appendChild(valueObject);
                            labelHolder.appendChild(nameObject);
                        }
                        chartContent.innerHTML = "";
                        chartContent.appendChild(bars);
                        if (displayType === "VERTICAL") {
                            chartContent.style.flexDirection = "column";
                            chartsCardContainer.style.height = "1500px";
                            bars.style.flexDirection = "column";
                            bars.style.alignItems = "flex-start";
                        } else {
                            chartContent.style.flexDirection = "row";
                            chartsCardContainer.style.height = "410px";
                            bars.style.flexDirection = "row";
                            bars.style.alignItems = "flex-end";
                        }
                        status.innerText = "chart generated";
                    }

                    function generateChartGivenCategory(data, displayType, valueType, category) {
                        status.innerText = "switching displayType...."
                        switch (displayType) {
                            case "HORIZONTAL":
                                createChart(data, valueType, false, category);
                                break;
                            case "VERTICAL":
                                createChart(data, valueType, true, category);
                                break;
                            default:
                                chartContent.textContent = "invalid display type: " + displayType;
                                break;
                        }
                    }

                    function generateChart() {
                        category = document.getElementById("categoryType").value;
                        displayType = document.getElementById("displayType").value;
                        valueType = document.getElementById("valueType").value;
                        status.textContent = `generating chart for category: ${category}, display type: ${displayType}, value type: ${valueType}`;
                        switch (category) {
                            case "USAGE":
                                generateChartGivenCategory(commandUsage, displayType, valueType, category);
                                break;
                            case "EXECUTION_TIME":
                                generateChartGivenCategory(averageExecutionTimes, displayType, valueType, category);
                                break;
                            case "HOURLY_USAGE":
                                generateChartGivenCategory(hourlyUsage, displayType, valueType, category);
                                break;
                            default:
                                chartContent.textContent = "invalid category: " + category;
                                break;
                        }
                    }
                    function formatTime(seconds) {
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.floor((seconds % 3600) / 60);
                        const remainingSeconds = seconds % 60;
                        return `${padZero(hours)}:${padZero(minutes)}:${padZero(
                            remainingSeconds
                        )}`;
                    }

                    function padZero(number) {
                        return number.toString().padStart(2, "0");
                    }
                    const stats =
                        document.getElementById("statsContainer");
                    stats.textContent = `version: ${jsonData.version}
system: ${jsonData.system}
memory usage: ${jsonData.mem}
wasted space: ${jsonData.wasted_space}
total GPT messages: ${statistics.gpt}
total commands used: ${totalUsage}
total slash commands used: ${statistics.commandTypeUsage.slash}
total text commands used: ${statistics.commandTypeUsage.text}
total running shards: ${jsonData.shardCount}
total request count: ${statistics.requestCount}

site started at: ${jsonData.starts.site.startedAt}
bot started at: ${jsonData.starts.bot.startedAt}
shard started at: ${jsonData.starts.shard.startedAt}
site uptime: ${formatTime(
                        Math.floor(
                            (Date.now() -
                                jsonData.starts.site.startedAtTimestamp) /
                                1000
                        )
                    )}
bot uptime: ${formatTime(
                        Math.floor(
                            (Date.now() -
                                jsonData.starts.bot.startedAtTimestamp) /
                                1000
                        )
                    )}
shard uptime: ${formatTime(
                        Math.floor(
                            (Date.now() -
                                jsonData.starts.shard.startedAtTimestamp) /
                                1000
                        )
                    )}

                    `;
                    const categoryObject = document.getElementById("categoryType");
                    const displayObject = document.getElementById("displayType");
                    const valueObject = document.getElementById("valueType");
                
                    const defaultValueTypeForCategory = {
                        "USAGE": "PERCENTAGE",
                        "EXECUTION_TIME": "INTEGER",
                        "HOURLY_USAGE": "INTEGER"
                    }

                    categoryObject.addEventListener("change", () => {
                        valueObject.value = defaultValueTypeForCategory[categoryObject.value];
                        generateChart();
                    });
                    displayObject.addEventListener("change", generateChart);
                    valueObject.addEventListener("change", generateChart);
                    generateChart();
                })
                .catch((error) => {console.error("Error:", error); document.getElementById("status").innerText = error + error.stack;});
        </script>
        <script id="mobiledisplay">
            const displayObjectMobile = document.getElementById("displayType");
            function enableMobileMode() {
                displayObjectMobile.value = "VERTICAL";
                const event = new Event('change');
                displayObjectMobile.dispatchEvent(event);
            }
            function disableMobileMode() {
                displayObjectMobile.value = "HORIZONTAL";
                const event = new Event('change');
                displayObjectMobile.dispatchEvent(event);
            }
            let mobileMode = sessionStorage.getItem("mobileMode") === "true";
            function toggleMobileMode() {
                if (mobileMode) {
                    disableMobileMode();
                } else {
                    enableMobileMode();
                }
                mobileMode = !mobileMode;
                sessionStorage.setItem("mobileMode", mobileMode);
            }
            if (/Mobi|Android/i.test(navigator.userAgent)) {
                if (!mobileMode) {
                    toggleMobileMode();
                }
            }
            function checkMobileMode() {
                if (window.matchMedia("(max-width: 1280px)").matches) {
                    if (!mobileMode) {
                        toggleMobileMode();
                    }
                } else {
                    if (mobileMode) {
                        toggleMobileMode();
                    }
                }
            }
            const mobileModeOverrideBeforeCheck = sessionStorage.getItem("mobileMode") === "true";

            // Initial check
            checkMobileMode();
            if (mobileModeOverrideBeforeCheck) {
                enableMobileMode();
                mobileMode = true
            }

            // Add event listener for screen size changes
            window.addEventListener("resize", checkMobileMode);
        </script>
    </body>
</html>
