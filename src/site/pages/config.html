<!DOCTYPE html>
<html>
    <head>
        <title>Config</title>
        <link rel="stylesheet" type="text/css" href="/style.css" />
        <link rel="icon" type="image/x-icon" href="../images/favicon.ico" />
        <meta content="Config" property="og:title" />
        <meta content="allows you to edit settings for pepperbot in servers you have admin in" property="og:description" />
        <meta content="https://pepperbot.online/logs" property="og:url" />
        <meta content="#ff0000" data-react-helmet="true" name="theme-color" />
    </head>
    <body>
        <script src="/scripts/tv.js"></script>
        <script src="/scripts/sidebar.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <pre id="debug" style="position: absolute;"></pre>
        <span class="outlined" id="requestOAuth" style="position: fixed; top: 50vh; left: 50vw; transform: translate(-50%, -50%); padding: 7px; display: none">unable to find OAuth2 token, please <a href="/auth">reauthenticate</a></span>
        <div class="outlined logPageContainer flex" id="guildList" style="display: none; flex-direction: column;">
            <span class="outlined" id="loadingMessage" style="position: fixed; top: 50vh; left: 50vw; transform: translate(-50%, -50%); padding: 7px;">loading guilds, please wait...</span>
        </div>
        <script id="sidebarAdjustments">
            document.addEventListener('DOMContentLoaded', tvStaticAnimation)
            const guildListElement = document.getElementById('guildList');
            function editTextAreaSize(sidebarState) {
                if (window.innerWidth < 768) {
                    guildListElement.style.width = "calc(100% - 12px)"
                } else if (sidebarState) {
                    guildListElement.style.width = "calc(100% - 164px)"
                } else {
                    guildListElement.style.width = "calc(100% - 22px)"
                }
            }
            bindToSidebarToggle(editTextAreaSize)
        </script>
        <script>
            const debug = document.getElementById('debug');
            function createTrueFalseInput(id, initialValue) {
                const trueColor = '#4CAF50';
                const falseColor = '#f44336';
                
                const button = document.createElement('button');
                button.className = 'trueFalseButton';
                button.innerText = initialValue ? 'TRUE' : 'FALSE';
                button.style.color = initialValue ? trueColor : falseColor;
                button.id = id;

                let buttonValue = initialValue
                button.addEventListener('click', () => {
                    buttonValue = !buttonValue;
                    button.innerText = buttonValue ? 'TRUE' : 'FALSE';
                    button.style.color = buttonValue ? trueColor : falseColor;
                    document.getElementById(id).querySelector('input').value = buttonValue;
                });

                return button;
            }

            function createCommandCategory(name) {
                const commandCategory = document.createElement('details');
                commandCategory.className = 'configCommandCategory normalized';
                commandCategory.open = true;

                const summary = document.createElement('summary');
                summary.className = 'configCommandCategorySummary';
                summary.innerText = name;
                commandCategory.appendChild(summary);

                return commandCategory;
            }

            function createConfigPair(key, value, richInfo, last) {
                const pair = document.createElement('div');
                pair.className = 'configPair';
                if (last) {
                    pair.className += " lastConfigPair"
                }

                const labelHolder = document.createElement('div');
                labelHolder.className = 'configPairLabelHolder';
                pair.appendChild(labelHolder);

                const pairName = document.createElement('span');
                pairName.className = 'configPairName';
                pairName.innerText = richInfo.cleanname;
                labelHolder.appendChild(pairName);

                const pairDescription = document.createElement('span');
                pairDescription.className = 'configPairDescription';
                pairDescription.innerText = richInfo.description;
                labelHolder.appendChild(pairDescription);

                pair.id = key;

                pair.appendChild(value);

                return pair;
            }

            function createGuildConfigMenu(gconfig, richGuildConfigInfo){
                const guildConfigMenu = document.createElement('div');

                const controllerContainer = document.createElement('div');
                controllerContainer.className = 'gconfigControllerContainer';
                guildConfigMenu.appendChild(controllerContainer);

                const submitButton = document.createElement('button');
                submitButton.innerText = 'SUBMIT';
                submitButton.className = 'gconifgSubmitButton';
                controllerContainer.appendChild(submitButton);

                const statusMessage = document.createElement('span');
                statusMessage.className = 'gconfigStatusMessage';
                controllerContainer.appendChild(statusMessage);

                statusMessage.innerText = 'creating buttons...';

                const commandsCategory = createCommandCategory('Commands');
                const disableTextCommands = createConfigPair("disableTextCommands", createTrueFalseInput('disableTextCommandsInput', gconfig.disableTextCommands), richGuildConfigInfo["disableTextCommands"]);
                commandsCategory.appendChild(disableTextCommands);
                const disableSlashCommands = createConfigPair("disableSlashCommands", createTrueFalseInput('disableSlashCommandsInput', gconfig.disableSlashCommands), richGuildConfigInfo["disableSlashCommands"]);
                commandsCategory.appendChild(disableSlashCommands);
                const disableAllCommands = createConfigPair("disableAllCommands", createTrueFalseInput('disableAllCommandsInput', gconfig.disableAllCommands), richGuildConfigInfo["disableAllCommands"]);
                commandsCategory.appendChild(disableAllCommands);
                const blacklistedCommandChannelIds = createConfigPair("blacklistedCommandChannelIds", document.createElement('p'), richGuildConfigInfo["blacklistedCommandChannelIds"], true);
                blacklistedCommandChannelIds.querySelector("p").innerText = "channel selectors are not finished"
                commandsCategory.appendChild(blacklistedCommandChannelIds);

                const diabolicalEventsCategory = createCommandCategory('Diabolical Events');
                const disableDiabolicalEvents = createConfigPair("disableDiabolicalEvents", createTrueFalseInput('disableDiabolicalEventsInput', gconfig.disableDiabolicalEvents), richGuildConfigInfo["disableDiabolicalEvents"]);
                diabolicalEventsCategory.appendChild(disableDiabolicalEvents);
                const diabolicalEventBlacklistedChannelIds = createConfigPair("diabolicalEventBlacklistedChannelIds", document.createElement('p'), richGuildConfigInfo["diabolicalEventBlacklistedChannelIds"]);
                diabolicalEventBlacklistedChannelIds.querySelector("p").innerText = "channel selectors are not finished"
                diabolicalEventsCategory.appendChild(diabolicalEventBlacklistedChannelIds);
                const diabolicalReactionEventChance = createConfigPair("diabolicalReactionEventChance", document.createElement('input'), richGuildConfigInfo["diabolicalReactionEventChance"]);
                diabolicalReactionEventChance.querySelector('input').value = gconfig.diabolicalReactionEventChance * 100 + "%";
                diabolicalReactionEventChance.querySelector('input').className = 'diabolicalEventChanceInput'
                diabolicalEventsCategory.appendChild(diabolicalReactionEventChance);
                const diabolicalReplyEventChance = createConfigPair("diabolicalReplyEventChance", document.createElement('input'), richGuildConfigInfo["diabolicalReplyEventChance"]);
                diabolicalReplyEventChance.querySelector('input').value = gconfig.diabolicalReplyEventChance * 100 + "%";
                diabolicalReplyEventChance.querySelector('input').className = 'diabolicalEventChanceInput'
                diabolicalEventsCategory.appendChild(diabolicalReplyEventChance);
                const diabolicalThreadEventChance = createConfigPair("diabolicalThreadEventChance", document.createElement('input'), richGuildConfigInfo["diabolicalThreadEventChance"], true);
                diabolicalThreadEventChance.querySelector('input').value = gconfig.diabolicalThreadEventChance * 100 + "%";
                diabolicalThreadEventChance.querySelector('input').className = 'diabolicalEventChanceInput'
                diabolicalEventsCategory.appendChild(diabolicalThreadEventChance);
                
                const otherCategory = createCommandCategory('Other')
                const prefix = createConfigPair("prefix", document.createElement('input'), richGuildConfigInfo["prefix"])
                prefix.querySelector('input').value = gconfig.prefix
                otherCategory.appendChild(prefix)

                guildConfigMenu.appendChild(commandsCategory);
                guildConfigMenu.appendChild(diabolicalEventsCategory);
                guildConfigMenu.appendChild(otherCategory)

                statusMessage.innerText = 'awaiting input...'
                return guildConfigMenu;
            }

            let fetched = [];
            const userOAuthToken = localStorage.getItem('token');
            if (userOAuthToken == null) {
                const requestOAuth = document.getElementById('requestOAuth');
                requestOAuth.style.display = 'inherit';
                localStorage.setItem('oauth2Redirect', '/config');
            } else {
                fetch("/api/get-rich-guild-config-info").then((richGuildConfigInfoRaw) => richGuildConfigInfoRaw.json().then(richGuildConfigInfo => {
                console.log(richGuildConfigInfo)

                const guildList = document.getElementById('guildList');
                guildList.style.display = 'flex';
                fetch("/oauth2/getGuilds?sorted=true", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'OAuth2Token': userOAuthToken,
                    },
                }).then(response => response.json())
                .then(data => {
                    const loadingMessage = document.getElementById('loadingMessage');
                    loadingMessage.style.display = 'none';

                    const filteredData = data.filter(guild => (parseInt(guild.permissions) & 0x8) || (parseInt(guild.permissions) & 0x20));
                    console.log(filteredData)
                    if (filteredData.length === 0) {
                        const noGuildsMessage = document.createElement('span');
                        noGuildsMessage.innerText = 'you do not have the required permissions in any guilds. specifically i\'m looking for the manage server or administrator permissions, get those then come back. ';
                        guildList.appendChild(noGuildsMessage);
                        return;
                    }

                    filteredData.forEach(guild => {
                        const guildObject = document.createElement('details');
                        guildObject.id = guild.id;
                        guildObject.className = 'guildObject normalized';

                        const summary = document.createElement('summary');
                        summary.className = "guildSummary"

                        const guildIcon = document.createElement('img');
                        guildIcon.className = 'guildIcon';
                        guildIcon.src = `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png`;
                        summary.appendChild(guildIcon);

                        const guildName = document.createElement('span');
                        guildName.className = 'guildName';
                        guildName.innerText = guild.name;
                        summary.appendChild(guildName);

                        guildObject.appendChild(summary);

                        const configData = document.createElement('div');
                        configData.className = 'configData';
                        guildObject.appendChild(configData);

                        const loadingMessage = document.createElement('span');
                        loadingMessage.className = 'loadingMessage';
                        loadingMessage.innerText = 'loading guild config...';
                        configData.appendChild(loadingMessage);

                        guildObject.addEventListener('toggle', () => {
                            if (guildObject.open) {
                                if (fetched.includes(guild.id)) return;
                                fetched.push(guild.id);
                                const loadingMessage = configData.querySelector('.loadingMessage');
                                fetch(`/api/get-guild-config?gid=${guild.id}`, {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'OAuth2Token': userOAuthToken,
                                    },
                                }).then(response => response.json())
                                .then(config => {
                                    loadingMessage.style.display = 'none';
                                    const configContent = createGuildConfigMenu(config, richGuildConfigInfo);
                                    configData.appendChild(configContent);
                                }).catch(error => {
                                    loadingMessage.innerText = 'Failed to load config';
                                });
                            }
                        });

                        guildList.appendChild(guildObject);
                    });
                })}))};
        </script>
    </body>
</html>
